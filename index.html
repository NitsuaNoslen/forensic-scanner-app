<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Forensic Scanner IO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }

        /* Sensor Colors */
        :root {
            --default-color: #666666; 
            --sensor-color: var(--default-color);
        }
        
        body {
            background-color: #1a1a1a; 
            color: #e0e0e0;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden;
            touch-action: none;
            height: 100vh;
            height: 100dvh;
            display: flex;
            justify-content: center; 
            align-items: center;
        }

        /* Main App Container */
        #app-container {
            width: 100%;
            height: 100%;
            max-width: 480px;
            background-color: #000;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        @media (max-width: 480px) {
            #app-container {
                max-width: 100%;
                height: 100dvh;
                border: none;
            }
        }

        .scan-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: var(--sensor-color);
            box-shadow: 0 0 10px var(--sensor-color);
            animation: scan 2s linear infinite;
            opacity: 0.7;
            pointer-events: none;
            z-index: 10;
        }

        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .sensor-outline {
            border: 2px solid var(--sensor-color);
            box-shadow: inset 0 0 20px var(--sensor-color), 0 0 10px var(--sensor-color);
            transition: all 0.5s ease;
        }

        .hud-text {
            text-shadow: 0 0 5px var(--sensor-color);
            color: var(--sensor-color);
        }
        
        .sensor-indicator-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            opacity: 0.5;
            transition: all 0.3s ease;
            animation: pulse-dot 1.5s infinite;
        }

        @keyframes pulse-dot {
            0% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.3); opacity: 0.8; }
            100% { transform: scale(1); opacity: 0.5; }
        }
        
        .btn-mute {
            transition: color 0.3s ease;
        }

        /* Range Slider Styling */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: var(--sensor-color);
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 0 10px var(--sensor-color);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #333;
            border-radius: 2px;
        }

        /* Loading Spinner */
        .loader {
            border: 4px solid #333; 
            border-top: 4px solid var(--sensor-color); 
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none !important; }
        
        /* Chat Bubble Styles */
        .chat-bubble {
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 0.75rem;
            line-height: 1.2;
        }
        .chat-user {
            background-color: #333;
            color: #fff;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        .chat-ai {
            background-color: rgba(0, 240, 255, 0.1);
            color: #b0f0ff;
            align-self: flex-start;
            border: 1px solid rgba(0, 240, 255, 0.3);
            border-bottom-left-radius: 2px;
        }
    </style>
</head>
<body>

<div id="app-container">
    <!-- TOP BAR -->
    <div class="h-16 bg-black/90 flex justify-center items-center px-2 z-20 border-b border-gray-800 shrink-0">
        <div id="sensorStatusContainer" class="flex gap-4">
            <!-- Sensors rendered via JS -->
        </div>
    </div>

    <!-- MAIN VIEWPORT -->
    <div class="flex-1 relative bg-black overflow-hidden flex justify-center items-center min-h-0">
        <!-- Live Video -->
        <video id="cameraStream" autoplay playsinline muted class="absolute w-full h-full object-cover transition-transform duration-200" style="transform-origin: center;"></video>
        
        <!-- Freeze Frame Canvas -->
        <canvas id="captureCanvas" class="absolute w-full h-full object-cover hidden"></canvas>

        <!-- Sensor Overlay -->
        <div id="sensorOverlay" class="absolute inset-4 sensor-outline pointer-events-none z-10 flex flex-col justify-between p-4">
            <div class="flex justify-between items-start">
                <span class="hud-text text-xs tracking-widest">AUTO-SCAN MODE</span>
                <span id="zoomIndicator" class="text-xs font-mono text-gray-400">1.0x [OPTICAL]</span>
            </div>
            
            <!-- Crosshairs -->
            <div class="absolute top-1/2 left-1/2 w-12 h-12 border border-white/30 -translate-x-1/2 -translate-y-1/2 flex items-center justify-center">
                <div class="w-1 h-3 bg-white/50 absolute"></div>
                <div class="h-1 w-3 bg-white/50 absolute"></div>
            </div>

            <!-- Scan Line -->
            <div id="scanLine" class="scan-line hidden"></div>
        </div>
        
        <!-- MUTE BUTTON -->
        <button onclick="toggleMute()" id="muteBtn" class="btn-mute absolute bottom-4 right-4 p-3 rounded-full bg-black/50 backdrop-blur-sm z-30 text-gray-500 hover:text-white transition-colors">
            <i class="fa-solid fa-volume-xmark text-xl"></i>
        </button>

        <!-- Loading State -->
        <div id="loaderOverlay" class="absolute inset-0 bg-black/80 z-40 hidden flex flex-col items-center justify-center">
            <div class="loader mb-4"></div>
            <p class="text-sm font-mono animate-pulse text-white">ACCESSING NEURAL NET...</p>
            <p id="analysisStatus" class="text-xs text-gray-400 mt-2">Determining optimal sensor type...</p>
        </div>
        
        <!-- Camera Error Display -->
        <div id="cameraError" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 hidden p-4 bg-red-900/80 border border-red-500 rounded-lg text-white text-center w-3/4">
            <i class="fa-solid fa-triangle-exclamation text-xl mb-2"></i>
            <p class="text-sm font-bold">CAMERA UNAVAILABLE</p>
            <p class="text-xs text-gray-300 mt-1">If on desktop, check browser permissions.<br>If on mobile, ensure website has camera access.</p>
        </div>
    </div>

    <!-- BOTTOM BAR -->
    <div class="bg-black/90 p-4 z-20 border-t border-gray-800 flex flex-col gap-3 shrink-0 pb-6">
        
        <!-- Zoom Slider -->
        <div class="flex items-center gap-3 px-2">
            <i class="fa-solid fa-magnifying-glass-minus text-gray-500 text-xs"></i>
            <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1" class="w-full">
            <i class="fa-solid fa-magnifying-glass-plus text-gray-500 text-xs"></i>
        </div>

        <!-- Camera Select Buttons -->
        <div id="cameraSelectContainer" class="flex gap-2 justify-center overflow-x-auto py-1"></div>

        <!-- Main Actions -->
        <div class="flex justify-between items-center mt-1">
            <button onclick="document.getElementById('fileInput').click()" class="p-3 text-gray-400 hover:text-white flex flex-col items-center w-16">
                <i class="fa-solid fa-upload text-xl"></i>
                <span class="text-[9px] mt-1">UPLOAD</span>
                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
            </button>

            <button onclick="startScan()" id="scanBtn" class="w-16 h-16 rounded-full border-4 border-white flex items-center justify-center bg-white/10 hover:bg-white/30 active:scale-95 transition-all">
                <div class="w-12 h-12 rounded-full bg-white"></div>
            </button>

            <button onclick="toggleLibrary()" class="p-3 text-gray-400 hover:text-white flex flex-col items-center w-16 relative">
                <i class="fa-solid fa-box-archive text-xl"></i>
                <span class="text-[9px] mt-1">ARCHIVE</span>
                <span id="archiveCount" class="absolute top-0 right-2 bg-red-600 text-white text-[8px] px-1 rounded-full hidden">0</span>
            </button>
        </div>
    </div>

    <!-- RESULTS MODAL -->
    <div id="resultsModal" class="absolute inset-0 bg-black z-50 transform translate-y-full transition-transform duration-300 flex flex-col h-full">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900 shrink-0">
            <h2 class="text-lg font-bold tracking-widest text-white"><i class="fa-solid fa-square-poll-vertical mr-2"></i>ANALYSIS COMPLETE</h2>
            <button onclick="closeResults()" class="text-gray-400 hover:text-white">
                <i class="fa-solid fa-xmark text-2xl"></i>
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-6 pb-20">
            <div class="w-full h-48 bg-gray-800 rounded-lg overflow-hidden border border-gray-700 relative">
                <img id="resultImage" class="w-full h-full object-cover opacity-80">
                <div class="absolute bottom-0 left-0 bg-black/70 px-2 py-1 text-xs font-mono text-white w-full">
                    SENSOR: <span id="resultSensorType" class="text-blue-400 font-bold uppercase">MERCH</span>
                </div>
            </div>
            
            <!-- Quick Actions Toolbar (NEW) -->
            <div class="flex gap-2 mb-2">
                <button onclick="openChatModal()" class="flex-1 bg-gray-800 hover:bg-gray-700 text-xs font-mono text-white py-3 rounded border border-gray-600 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-comments"></i> ✨ AI INTERROGATOR
                </button>
                <button onclick="generateFieldReport()" class="flex-1 bg-gray-800 hover:bg-gray-700 text-xs font-mono text-white py-3 rounded border border-gray-600 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-file-contract"></i> ✨ REPORT
                </button>
            </div>

            <div class="bg-gray-900/50 border border-gray-700 rounded-lg p-4">
                <h3 class="text-sm text-gray-400 uppercase tracking-widest mb-3 border-b border-gray-800 pb-2">Primary Target Analysis</h3>
                <div id="resultContent" class="space-y-3 font-mono text-sm"></div>
            </div>
            <div>
                <h3 class="text-sm text-gray-400 uppercase tracking-widest mb-3 flex justify-between items-center">
                    <span>Reference Database Matches</span>
                    <span class="text-[10px] bg-green-900 text-green-300 px-2 py-0.5 rounded">4 FOUND</span>
                </h3>
                <div class="grid grid-cols-2 gap-2" id="referenceGrid"></div>
            </div>
        </div>
    </div>
    
    <!-- IMAGE PREVIEW MODAL -->
    <div id="imagePreviewModal" class="absolute inset-0 bg-black/95 z-[60] hidden flex items-center justify-center p-4" onclick="closeImagePreview()">
        <div class="relative w-full max-w-lg mx-auto bg-gray-900 rounded-lg p-4 shadow-xl border border-gray-700" onclick="event.stopPropagation()">
            <button onclick="closeImagePreview()" class="absolute top-2 right-2 text-white bg-black/50 hover:bg-black/80 rounded-full p-2 z-10">
                <i class="fa-solid fa-xmark text-lg"></i>
            </button>
            <div class="w-full aspect-video bg-black flex items-center justify-center rounded overflow-hidden">
                <img id="previewImage" class="w-full h-full object-contain" src="" alt="Reference Image Preview">
            </div>
            <div class="mt-4 text-center">
                <p class="text-xs font-mono text-gray-500 uppercase">Forensic Reference ID: <span id="previewId" class="text-white"></span></p>
                <p id="previewCaption" class="text-sm font-mono text-white mt-1 border-t border-gray-800 pt-2"></p>
                <p id="previewScore" class="text-lg font-bold text-green-400 mt-2"></p>
            </div>
        </div>
    </div>

    <!-- CHAT MODAL (NEW) -->
    <div id="chatModal" class="absolute inset-0 bg-black z-[70] transform translate-x-full transition-transform duration-300 flex flex-col h-full">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-900 shrink-0">
            <h2 class="text-sm font-bold tracking-widest text-blue-400"><i class="fa-solid fa-robot mr-2"></i>AI INTERROGATOR</h2>
            <button onclick="closeChatModal()" class="text-gray-400 hover:text-white">
                <i class="fa-solid fa-chevron-right text-lg"></i>
            </button>
        </div>
        <div id="chatHistory" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2 font-mono text-sm bg-black/90">
            <div class="chat-bubble chat-ai">
                System Online. I have analyzed the forensic data. What specific details do you require about the specimen?
            </div>
        </div>
        <div class="p-3 bg-gray-900 border-t border-gray-800 shrink-0 flex gap-2">
            <input type="text" id="chatInput" placeholder="Ask about toxicity, origin, legal status..." class="flex-1 bg-gray-800 border border-gray-700 rounded px-3 py-2 text-sm text-white focus:outline-none focus:border-blue-500">
            <button onclick="sendChatMessage()" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-500">
                <i class="fa-solid fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- REPORT MODAL (NEW) -->
    <div id="reportModal" class="absolute inset-0 bg-black/95 z-[80] hidden flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-lg bg-white text-black rounded-sm p-6 shadow-2xl relative h-[80vh] flex flex-col">
            <button onclick="closeReportModal()" class="absolute top-2 right-2 text-black hover:text-red-600 p-2">
                <i class="fa-solid fa-xmark text-xl"></i>
            </button>
            <div class="border-b-2 border-black pb-2 mb-4">
                <h2 class="text-xl font-bold uppercase tracking-tighter">Official Field Report</h2>
                <p class="text-xs font-mono">CLASSIFIED // EYES ONLY</p>
            </div>
            <div id="reportContent" class="flex-1 overflow-y-auto font-mono text-xs leading-relaxed whitespace-pre-wrap">
                Generating Report...
            </div>
            <div class="mt-4 pt-2 border-t border-black flex justify-between items-end">
                <div class="text-[10px] font-bold">AUTH: AI-9000</div>
                <div class="text-[10px]">SIGNATURE: ________________</div>
            </div>
        </div>
    </div>

    <!-- LIBRARY DRAWER -->
    <div id="libraryDrawer" class="absolute inset-y-0 right-0 w-3/4 bg-gray-900 z-50 transform translate-x-full transition-transform duration-300 shadow-2xl border-l border-gray-700 flex flex-col h-full">
        <div class="p-4 border-b border-gray-800 flex justify-between items-center shrink-0">
            <h2 class="text-white font-bold tracking-widest">ARCHIVES</h2>
            <button onclick="toggleLibrary()" class="text-white"><i class="fa-solid fa-chevron-right"></i></button>
        </div>
        <div id="archiveList" class="flex-1 overflow-y-auto p-4 space-y-4">
            <p class="text-gray-500 text-center mt-10 text-sm font-mono">NO RECORDS FOUND</p>
        </div>
    </div>
</div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // CONFIG & STATE
        const sensors = {
            merch: { color: '#00f0ff', name: 'Merchandise', key: 'merch' },
            bio: { color: '#00ff41', name: 'Biological', key: 'bio' },
            pharma: { color: '#ff3333', name: 'Pharmaceutical', key: 'pharma' },
            control: { color: '#ff9900', name: 'Controlled Subst.', key: 'control' },
            default: { color: '#666666', name: 'Standard Scan', key: 'default' }
        };

        let currentSensor = 'merch';
        let stream = null;
        let videoTrack = null;
        let capabilities = {};
        let zoomLevel = 1;
        let isDigitalZoom = false;
        let archive = [];
        let isMuted = true;
        
        // STORE CURRENT SCAN DATA FOR LLM FEATURES
        let currentScanData = null; 

        // DOM ELEMENTS
        const video = document.getElementById('cameraStream');
        const canvas = document.getElementById('captureCanvas');
        const loader = document.getElementById('loaderOverlay');
        const scanLine = document.getElementById('scanLine');
        const muteBtn = document.getElementById('muteBtn');
        const cameraErrorDisplay = document.getElementById('cameraError');
        const sensorStatusContainer = document.getElementById('sensorStatusContainer');
        const imagePreviewModal = document.getElementById('imagePreviewModal');
        const chatModal = document.getElementById('chatModal');
        const reportModal = document.getElementById('reportModal');


        // --- 1. SENSOR LOGIC ---
        function resetSensorUI() {
            document.documentElement.style.setProperty('--sensor-color', '#666666');
            document.querySelectorAll('.sensor-status-item').forEach(item => {
                item.classList.remove('hud-text');
                item.classList.add('text-gray-500');
            });
        }
        
        window.setSensor = (key) => {
            currentSensor = key;
            const config = sensors[key];
            
            document.documentElement.style.setProperty('--sensor-color', config.color);
            
            document.querySelectorAll('.sensor-status-item').forEach(item => {
                if (item.dataset.sensor === key) {
                    item.classList.add('hud-text');
                    item.classList.remove('text-gray-500');
                } else {
                    item.classList.remove('hud-text');
                    item.classList.add('text-gray-500');
                }
            });
        };

        function renderSensorStatus() {
            const displaySensors = ['merch', 'bio', 'pharma', 'control'];
            sensorStatusContainer.innerHTML = displaySensors.map(key => {
                const config = sensors[key];
                return `
                    <div class="flex flex-col items-center gap-1 sensor-status-item text-gray-500" data-sensor="${key}">
                        <div id="sensor-dot-${key}" 
                             class="sensor-indicator-dot" 
                             style="background-color: ${config.color}; box-shadow: 0 0 8px ${config.color};">
                        </div>
                        <span class="text-[9px] uppercase tracking-widest">${config.name.split(' ')[0]}</span>
                    </div>
                `;
            }).join('');

            resetSensorUI();
        }

        // --- 2. CAMERA INITIALIZATION ---
        async function initCamera(deviceId = null) {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            cameraErrorDisplay.classList.add('hidden');

            const constraints = {
                video: {
                    deviceId: deviceId ? { exact: deviceId } : undefined,
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    facingMode: deviceId ? undefined : 'environment'
                },
                audio: false
            };

            try {
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                video.setAttribute('playsinline', ''); 
                video.play().catch(e => console.error("Video play failed:", e)); 
                
                video.muted = true;
                isMuted = true;
                toggleMute(); 

                video.onloadedmetadata = () => {
                    videoTrack = stream.getVideoTracks()[0];
                    capabilities = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
                    setupZoom();
                };

                if(!deviceId) enumerateCameras();

            } catch (err) {
                console.error("Camera Init Error (access denied or unavailable):", err);
                cameraErrorDisplay.classList.remove('hidden');
            }
        }

        async function enumerateCameras() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(d => d.kind === 'videoinput');
                const container = document.getElementById('cameraSelectContainer');
                container.innerHTML = '';

                if (videoDevices.length > 1) {
                    videoDevices.forEach((device, index) => {
                        const btn = document.createElement('button');
                        btn.className = "px-3 py-1 bg-gray-800 rounded text-[10px] text-gray-300 border border-gray-600 hover:bg-gray-700 whitespace-nowrap";
                        btn.innerHTML = device.label || `Cam ${index + 1}`;
                        btn.onclick = () => initCamera(device.deviceId);
                        container.appendChild(btn);
                    });
                }
            } catch (e) {
                console.warn("Enumeration failed", e);
            }
        }
        
        // --- 3. MUTE TOGGLE LOGIC ---
        window.toggleMute = () => {
            isMuted = !isMuted;
            video.muted = isMuted;

            if (isMuted) {
                muteBtn.innerHTML = '<i class="fa-solid fa-volume-xmark text-xl"></i>';
                muteBtn.classList.remove('text-red-400');
                muteBtn.classList.add('text-gray-500');
            } else {
                muteBtn.innerHTML = '<i class="fa-solid fa-volume-high text-xl"></i>';
                muteBtn.classList.remove('text-gray-500');
                muteBtn.classList.add('text-red-400');
            }
        };

        // --- 4. ZOOM LOGIC ---
        function setupZoom() {
            const zoomSlider = document.getElementById('zoomSlider');
            const zoomIndicator = document.getElementById('zoomIndicator');
            
            if (capabilities.zoom) {
                isDigitalZoom = false;
                zoomSlider.min = capabilities.zoom.min;
                zoomSlider.max = capabilities.zoom.max;
                zoomSlider.step = capabilities.zoom.step;
                zoomIndicator.innerText = `${parseFloat(zoomSlider.value).toFixed(1)}x [OPTICAL]`;
            } else {
                isDigitalZoom = true;
                zoomSlider.min = 1;
                zoomSlider.max = 5;
                zoomSlider.step = 0.1;
                zoomIndicator.innerText = "1.0x [DIGITAL]";
            }
        }

        zoomSlider.oninput = async (e) => {
            const value = parseFloat(e.target.value);
            zoomLevel = value;
            
            if (!isDigitalZoom && videoTrack) {
                try {
                    await videoTrack.applyConstraints({ advanced: [{ zoom: value }] });
                    zoomIndicator.innerText = `${value.toFixed(1)}x [OPTICAL]`;
                } catch (err) {
                    isDigitalZoom = true;
                    applyDigitalZoom(value);
                }
            } else {
                applyDigitalZoom(value);
            }
        };

        function applyDigitalZoom(val) {
            video.style.transform = `scale(${val})`;
            zoomIndicator.innerText = `${val.toFixed(1)}x [DIGITAL]`;
        }

        // --- 5. IMAGE CAPTURE & ANALYSIS ---
        window.startScan = async () => {
            if (!stream || !videoTrack || video.classList.contains('hidden')) {
                console.error("Cannot start scan: Camera stream is not active or initialized.");
                cameraErrorDisplay.classList.remove('hidden');
                return;
            }
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            
            if (isDigitalZoom) {
                const w = canvas.width / zoomLevel;
                const h = canvas.height / zoomLevel;
                const x = (canvas.width - w) / 2;
                const y = (canvas.height - h) / 2;
                ctx.drawImage(video, x, y, w, h, 0, 0, canvas.width, canvas.height);
            } else {
                ctx.drawImage(video, 0, 0);
            }

            video.classList.add('hidden');
            canvas.classList.remove('hidden');
            scanLine.classList.remove('hidden');
            loader.classList.remove('hidden');
            document.getElementById('analysisStatus').innerText = "Determining optimal sensor type...";
            resetSensorUI();

            const base64Data = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
            
            await analyzeImage(base64Data);
        };

        window.handleFileUpload = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0);
                    
                    video.classList.add('hidden');
                    canvas.classList.remove('hidden');
                    loader.classList.remove('hidden');
                    scanLine.classList.remove('hidden');
                    
                    const base64Data = e.target.result.split(',')[1];
                    resetSensorUI();
                    analyzeImage(base64Data);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        // SHARED API KEY VARIABLE
        // !!! REPLACE WITH YOUR ACTUAL KEY !!!
        const apiKey = "AIzaSyDa6msAMrCKQSZR9fOLueLT0N9bUGZ6mCM"; 

        async function analyzeImage(base64Image) {
            
            if (!apiKey) {
                console.warn("NO API KEY DETECTED. Analysis skipped.");
                const simulatedData = {
                    determinedSensor: 'default',
                    subjectType: 'Simulated Object (No Key)',
                    summary: 'Analysis requires a Gemini API key. Displaying simulated data.',
                    details: [{label: "Age", value: "N/A"}, {label: "Rested Status", value: "N/A"}, {label: "Sensor Match", value: "N/A"}],
                    searchTerms: "Simulated, Placeholder, Data, Test",
                    referenceImages: [{desc: "Simulated Reference 1"}, {desc: "Simulated Reference 2"}, {desc: "Simulated Reference 3"}, {desc: "Simulated Reference 4"}]
                };
                currentScanData = simulatedData; // Save for Chat/Report
                return renderResults(simulatedData, base64Image, true);
            }

            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });

                const prompt = `
                    You are a Forensic AI Scanner.
                    
                    TASK 1: Determine the single most appropriate sensor module for the visual content.
                    Options: "merch", "bio", "pharma", "control", or "default".
                    - "merch": Commercial goods, clothing, brands, electronics.
                    - "bio": People, animals, tissues, health indicators.
                    - "pharma": Medications, pills, clinical samples.
                    - "control": Prohibited/regulated items (weapons, illicit substances).
                    - "default": Clouds, landscapes, sky, generic nature, floors, walls, or anything that DOES NOT fit the above 4 specific categories.

                    TASK 2: Perform forensic analysis based on the determined sensor type.
                    STRICT RULES: 
                    1. If "default" is chosen, provide a standard environmental scan analysis.
                    2. If a PERSON is visible (full body or face): Analyze the person. ESTIMATE AGE. DETERMINE IF "WELL RESTED". IGNORE any held objects. 
                    3. If a HAND is holding an object (no face): IGNORE the hand. ANALYZE THE OBJECT strictly. 
                    4. Generate 10 distinct, highly specific search terms for Google Images to find references.
                    
                    Provide output ONLY in JSON format: { "determinedSensor": "...", "subjectType": "...", "summary": "...", "details": [{...}], "searchTerms": "...", "referenceImages": [...] }
                `;

                document.getElementById('analysisStatus').innerText = "Running AI Analysis and Sensor Selection...";

                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error("Analysis Timeout")), 15000)
                );

                const resultPromise = model.generateContent([
                    prompt,
                    { inlineData: { data: base64Image, mimeType: "image/jpeg" } }
                ]);

                const result = await Promise.race([resultPromise, timeoutPromise]);
                const response = await result.response;
                const text = response.text();
                
                let data;
                try {
                    const firstBrace = text.indexOf('{');
                    const lastBrace = text.lastIndexOf('}');
                    if (firstBrace !== -1 && lastBrace !== -1) {
                        const jsonStr = text.substring(firstBrace, lastBrace + 1);
                        data = JSON.parse(jsonStr);
                    } else {
                        throw new Error("No JSON found");
                    }
                } catch (e) {
                    console.error("JSON Parse Error", e);
                    throw new Error("Invalid AI Response Format");
                }

                currentScanData = data; // SAVE DATA FOR CHAT/REPORT
                renderResults(data, base64Image, true);

            } catch (error) {
                console.error("Analysis Failed", error);
                
                const errorData = {
                    determinedSensor: 'default', 
                    subjectType: 'Scan Failure',
                    summary: `Analysis failed: ${error.message || "Connection Error"}. Please retry.`,
                    details: [{label: "Status", value: "Failed"}, {label: "Retry", value: "Recommended"}],
                    searchTerms: "error, glitch, static",
                    referenceImages: []
                };
                currentScanData = errorData;
                renderResults(errorData, base64Image, true);
            }
        }

        // --- NEW FEATURES: CHAT & REPORT ---

        window.openChatModal = () => {
            chatModal.classList.remove('translate-x-full');
        };

        window.closeChatModal = () => {
            chatModal.classList.add('translate-x-full');
        };

        window.sendChatMessage = async () => {
            const input = document.getElementById('chatInput');
            const history = document.getElementById('chatHistory');
            const question = input.value.trim();
            
            if (!question || !apiKey) return;

            // Add User Message
            const userDiv = document.createElement('div');
            userDiv.className = 'chat-bubble chat-user';
            userDiv.innerText = question;
            history.appendChild(userDiv);
            input.value = '';
            
            // Add Loading Message
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-bubble chat-ai animate-pulse';
            loadingDiv.innerText = "Analyzing request...";
            history.appendChild(loadingDiv);
            history.scrollTop = history.scrollHeight;

            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });
                
                // Context-aware prompt
                const prompt = `
                    You are a Forensic AI Assistant. 
                    Context of current scan: ${JSON.stringify(currentScanData)}.
                    User Question: "${question}"
                    Answer concisely (under 50 words) in a robotic, factual forensic tone.
                `;

                const result = await model.generateContent(prompt);
                const response = result.response.text();

                // Replace loading with response
                history.removeChild(loadingDiv);
                const aiDiv = document.createElement('div');
                aiDiv.className = 'chat-bubble chat-ai';
                aiDiv.innerText = response;
                history.appendChild(aiDiv);
                history.scrollTop = history.scrollHeight;

            } catch (err) {
                history.removeChild(loadingDiv);
                const errDiv = document.createElement('div');
                errDiv.className = 'chat-bubble chat-ai text-red-400';
                errDiv.innerText = "Connection Error. Unable to process query.";
                history.appendChild(errDiv);
            }
        };

        window.generateFieldReport = async () => {
            if (!currentScanData || !apiKey) return;
            
            reportModal.classList.remove('hidden');
            const contentDiv = document.getElementById('reportContent');
            contentDiv.innerText = "Initializing Document Generator...\nAccessing Case Files...\nCompiling Data...";

            try {
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });
                
                const prompt = `
                    Generate a formal, military/police style forensic field report based on this scan data: ${JSON.stringify(currentScanData)}.
                    Format: Plain text. Include Case ID (random), Date, Subject Description, Risk Assessment, and Final Recommendation.
                    Keep it serious and bureaucratic.
                `;

                const result = await model.generateContent(prompt);
                contentDiv.innerText = result.response.text();

            } catch (err) {
                contentDiv.innerText = "Error Generating Report. Encryption Key Invalid.";
            }
        };

        window.closeReportModal = () => {
            reportModal.classList.add('hidden');
        };


        // --- 6. RENDER RESULTS ---
        function renderResults(data, imageBase64, isNewScan) {
            const determinedSensorKey = (data.determinedSensor && sensors[data.determinedSensor]) ? data.determinedSensor : 'default';
            const determinedSensorConfig = sensors[determinedSensorKey];

            setSensor(determinedSensorKey);
            
            loader.classList.add('hidden');
            scanLine.classList.add('hidden');
            
            document.getElementById('resultImage').src = `data:image/jpeg;base64,${imageBase64}`;
            document.getElementById('resultSensorType').innerText = determinedSensorConfig.name;
            document.getElementById('resultSensorType').style.color = determinedSensorConfig.color;

            const contentDiv = document.getElementById('resultContent');
            contentDiv.innerHTML = `
                <div class="mb-4">
                    <span class="text-xs text-gray-500">SUBJECT</span>
                    <p class="text-xl font-bold text-white">${data.subjectType.toUpperCase()}</p>
                    <p class="text-sm text-gray-300 italic">"${data.summary}"</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-black/40 p-2 border-l-2" style="border-color: ${determinedSensorConfig.color}">
                        <span class="block text-[10px] text-gray-500 uppercase">AI Sensor</span>
                        <span class="block text-sm font-bold text-white">${determinedSensorConfig.name}</span>
                    </div>
                    ${(data.details || []).map(d => `
                        <div class="bg-black/40 p-2 border-l-2" style="border-color: ${determinedSensorConfig.color}">
                            <span class="block text-[10px] text-gray-500 uppercase">${d.label}</span>
                            <span class="block text-sm font-bold text-white">${d.value}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            const refGrid = document.getElementById('referenceGrid');
            const refs = (data.referenceImages || []).slice(0, 4);
            
            if (refs.length === 0) {
                refGrid.innerHTML = '<p class="col-span-2 text-center text-xs text-gray-500 py-4">No reference matches found.</p>';
            } else {
                refGrid.innerHTML = refs.map((img, i) => {
                    const genPrompt = encodeURIComponent(`${data.subjectType} ${img.desc} realistic photography forensic detail 8k`);
                    const randomSeed = Math.floor(Math.random() * 1000);
                    const imageUrl = `https://image.pollinations.ai/prompt/${genPrompt}?width=400&height=300&seed=${randomSeed}&nologo=true`;
                    
                    const simulatedScore = (90 + i * 2.1 + (Math.random() * 5)).toFixed(1);
                    const safeDesc = img.desc.replace(/'/g, "&apos;").replace(/"/g, "&quot;");

                    return `
                        <div onclick="showImagePreview('${imageUrl}', '${safeDesc}', '${simulatedScore}%', 'REF-${1000+i}')" 
                             class="bg-gray-800 rounded p-2 flex flex-col items-center justify-center text-center h-24 border border-gray-700 cursor-pointer hover:bg-gray-700 transition-all relative overflow-hidden group">
                            <img src="${imageUrl}" 
                                 class="absolute inset-0 w-full h-full object-cover opacity-60 group-hover:opacity-80 transition-opacity"
                                 loading="lazy"
                                 onerror="this.src='https://placehold.co/400x300/333/666?text=Ref+Img+Error'">
                            <div class="absolute inset-0 bg-black/40"></div>
                            <span class="text-[9px] text-white z-10 font-bold overflow-hidden line-clamp-2 drop-shadow-md relative px-1">${img.desc}</span>
                            <span class="text-[8px] text-green-400 mt-1 z-10 drop-shadow-md relative bg-black/60 px-1 rounded">${simulatedScore}% MATCH</span>
                        </div>
                    `;
                }).join('');
            }

            if (isNewScan) {
                addToArchive(data, imageBase64);
            }

            document.getElementById('resultsModal').classList.remove('translate-y-full');
        }
        
        window.showImagePreview = (imageUrl, caption, score, id) => {
            const modalImage = document.getElementById('previewImage');
            const modalCaption = document.getElementById('previewCaption');
            const modalScore = document.getElementById('previewScore');
            const modalId = document.getElementById('previewId');
            const determinedSensorConfig = sensors[currentSensor] || sensors['merch'];

            modalImage.src = imageUrl;
            modalCaption.textContent = caption;
            modalScore.textContent = score + " CONFIDENCE";
            modalId.textContent = id || "UNK-000";
            modalScore.style.color = determinedSensorConfig.color; 
            imagePreviewModal.classList.remove('hidden');
        };

        window.closeImagePreview = () => {
            imagePreviewModal.classList.add('hidden');
        };

        function addToArchive(data, imgBase64) {
            const entry = {
                id: Date.now(),
                timestamp: new Date().toLocaleTimeString(),
                sensor: data.determinedSensor,
                summary: data.summary,
                img: imgBase64,
                fullData: data
            };
            archive.unshift(entry);
            updateArchiveUI();
        }

        function updateArchiveUI() {
            const list = document.getElementById('archiveList');
            const count = document.getElementById('archiveCount');
            if (archive.length > 0) {
                count.innerText = archive.length;
                count.classList.remove('hidden');
                list.innerHTML = archive.map(item => `
                    <div onclick="showArchivedResult(${item.id})" class="bg-gray-800 p-3 rounded border-l-4 border-gray-600 flex gap-3 cursor-pointer hover:bg-gray-700 transition-colors" style="border-left-color: ${sensors[item.sensor]?.color || '#666666'}">
                        <img src="data:image/jpeg;base64,${item.img}" class="w-16 h-16 object-cover rounded bg-black">
                        <div class="flex-1 overflow-hidden">
                            <div class="flex justify-between items-start">
                                <span class="text-xs font-bold text-white uppercase">${sensors[item.sensor]?.name || 'UNKNOWN'}</span>
                                <span class="text-[10px] text-gray-500">${item.timestamp}</span>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-1 line-clamp-2">${item.summary}</p>
                        </div>
                    </div>
                `).join('');
            } else {
                 list.innerHTML = '<p class="text-gray-500 text-center mt-10 text-sm font-mono">NO RECORDS FOUND</p>';
            }
        }

        window.showArchivedResult = (id) => {
            const item = archive.find(a => a.id === id);
            if (item) {
                resetSensorUI();
                renderResults(item.fullData, item.img, false); 
                document.getElementById('libraryDrawer').classList.add('translate-x-full');
            }
        };

        window.toggleLibrary = () => {
            const drawer = document.getElementById('libraryDrawer');
            if (drawer.classList.contains('translate-x-full')) {
                drawer.classList.remove('translate-x-full');
            } else {
                drawer.classList.add('translate-x-full');
            }
        };

        window.closeResults = () => {
            document.getElementById('resultsModal').classList.add('translate-y-full');
            video.classList.remove('hidden');
            canvas.classList.add('hidden');
        };

        renderSensorStatus();
        initCamera();

    </script>
</body>
</html>


